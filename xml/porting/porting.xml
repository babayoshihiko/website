<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE document SYSTEM "../finkdoc.dtd">

<document filename="index">
<title>Porting Unix software to Darwin and Mac OS X</title>
<shorttitle>Porting</shorttitle>
<cvsid>$Id: porting.xml,v 1.22 2002/06/23 04:09:01 dmrrsn Exp $</cvsid>

<preface>
<p>
This document contains hints for porting Unix applications to Darwin
and Mac OS X.
The information here applies to Mac OS X version 10.0.x and Darwin
1.3.x.
Both systems will be referred to as Darwin, since Mac OS X is actually
a superset of Darwin.
</p>
</preface>


<chapter filename="basics">
<title>Basics</title>
<shorttitle>Basics</shorttitle>


<section name="heritage"><title>Where Darwin came from</title>
<p>
Darwin is a Unix-like operating system that evolved from NeXTStep /
OpenStep.
Lore has it that it was initially forked off 4.4BSD Lite.
The BSD heritage still shows, in fact Darwin was recently modernized
with code from FreeBSD and NetBSD.
</p>
<p>
Darwin's kernel is based on a combination of Mach 3.0, BSD, and
proprietary functionality like the object-oriented driver layer
IOKit.
Although Mach originally is a micro-kernel design, the BSD kernel that
sits on top of it is monolithic and the two are now so intertwined
that they must be regarded as a single monolithic kernel.
</p>
<p>
The user-space tools and libraries shipped with Darwin are mostly of
the BSD persuation, as opposed to the GNU tools you get with Linux.
Apple is not as strict as other BSDs though, and goes for useful
compromises.
For example, Apple ships both BSD make and GNU make, with GNU make
installed as the default.
</p>
</section>


<section name="compiler"><title>The Compiler and Tools</title>
<p>
Short story:
The compiler is a gcc derivate, but installed as <code>cc</code>;
you may have to patch Makefiles.
Most packages won't build shared libraries.
If you get errors related to macros, use the
<code>-no-cpp-precomp</code> option.
</p>
<p>
Long story:
The compiler tool chain in the Mac OS X Developer Tools is a strange
beast.
The compiler is based on the gcc 2.95.2 suite, with modifications to
support the Objective C language and some Darwin quirks.
The preprocessor (<code>cpp</code>) is available in two versions.
One is the standard precompiler (from gcc 2.95.2), the other one is a
special precompiler written by Apple, with support for precompiled
headers.
The latter one is used by default, because it is faster.
However, some code doesn't compile with Apple's precompiler, so you
must use the <code>-no-cpp-precomp</code> option to get the standard
precompiler.
(Note: I previously recommended the <code>-traditional-cpp</code>
option.
The semantics of this option have changed slightly with GCC 3,
breaking most packages that use it.
<code>-no-cpp-precomp</code> has the desired effect on both the
current Developer Tools and future compilers based on GCC 3.)
</p>
<p>
The assembler says it's based on gas 1.38.
The linker is not based on GNU tools.
This is a problem when building shared libraries, as GNU libtool and
configure scripts generated by it don't know how to handle Apple's
linker.
</p>
</section>


<section name="host-type"><title>Host type</title>
<p>
Short story:
If configure fails with 'Can't determine host type', copy config.guess
and config.sub from /usr/libexec into the current directory.
</p>
<p>
Long story:
The GNU world uses a canonical format to specify system types.
It has three parts: cpu type, manufacturer and operating system.
Sometimes a fourth part is added - then the third part denotes the
kernel, while the fourth denotes the operating system.
All parts are lower case and concatenated using dashes.
Some examples:
<code>i586-pc-linux-gnu</code>,
<code>hppa1.1-hp-hpux10.20</code>,
<code>sparc-sun-solaris2.6</code>.
The host type for Mac OS X 10.0 is
<code>powerpc-apple-darwin1.3</code>.
</p>
<p>
Many packages that use autoconf want to know the host type of the
system they are compiled on.
(Side note: to support cross-compiling and porting, there are actually
three types - the host type, the build type and the target type.
Usually, they're all the same.)
You can either pass the host type to the configure script as a
parameter or you can let it guess.
</p>
<p>
The configure script uses two companion scripts to determine host
types.
<filename>config.guess</filename> tries to guess the host type,
<filename>config.sub</filename> is used to validate and canonicalize
the host type.
These scripts are maintained as separate entities, but they are
included in every package that uses them.
Until very recently, these scripts didn't know about Darwin or Mac OS
X.
If you have a package that doesn't recognize Darwin, you must replace
the config.guess and config.sub included in the package.
Luckily, Apple put working versions in /usr/libexec, so you can just
copy them from there.
</p>
</section>


<section name="libraries"><title>Libraries</title>
<p>
Short story:
You can safely remove <code>-lm</code> from Makefiles, but you don't
need to.
</p>
<p>
Long story:
Mac OS X doesn't have separate libc, libm, libcurses, libpthread
etc. libraries.
Instead, they're all part of the system library, libSystem.
(In earlier versions, this actually was the System framework.)
However, Apple placed appropriate symlinks in /usr/lib, so linking
with <code>-lm</code> will work.
The only exception is <code>-lutil</code>.
On other systems, libutil contains functions related to
pseudo-terminals and login accounting.
These functions are in libSystem, but there is no symlink to provide a
libutil.dylib.
</p>
</section>

</chapter>


<chapter filename="shared">
<title>Shared Code</title>
<shorttitle>Shared Code</shorttitle>

<section name="lib-and-mod"><title>Shared Libraries vs. Loadable Modules</title>
<p>
One Mach-O feature that hits many people by surprise is the strict
distinction between shared libraries and dynamically loadable
modules.
On ELF systems both are the same; any piece of shared code can be
used as a library and for dynamic loading.
</p>
<p>
Mach-O shared libraries have the file type MH_DYLIB and carry the
extension <code>.dylib</code>.
They can be linked against with the usual static linker flags,
e.g. <code>-lfoo</code> for libfoo.dylib.
However, they can not be loaded as a module.
(Side note: Shared libraries can be loaded dynamically through an
API. However, that API is different from the API for bundles and the
semantics make it useless for an dlopen() emulation. Most notably,
shared libraries can not be unloaded.)
</p>
<p>
Loadable modules are called "bundles" in Mach-O speak.
They have the file type MH_BUNDLE.
Since no component involved cares about it, they can carry any
extension.
The extension <code>.bundle</code> is recommended by Apple, but most
ported software uses <code>.so</code> for the sake of compatibility.
Bundles can be dynamically loaded and unloaded via dyld APIs, and
there is a wrapper that emulates <code>dlopen()</code> on top of that
API.
It is not possible to link against bundles as if they were shared
libraries.
However, it is possible that a bundle is linked against real shared
libraries; those will be loaded automatically when the bundle is
loaded.
</p>
</section>


<section name="version"><title>Version Numbering</title>
<p>
On an ELF system, version numbers are usually appended to the file
name of the shared library, e.g. <filename>libqt.so.2.3.0</filename>.
On Darwin, the version numbers are placed between the library name and
the extension, e.g. <filename>libqt.2.3.0.dylib</filename>.
Note that this allows you to request a specific version of the library
when linking, using <code>-lqt.2.3.0</code> for the example above.
</p>
<p>
When creating a shared library, you can specify a name to be used when
searching for the library at run time.
This is usual practice and allows several major versions of a library
to be installed at the same time.
On ELF systems this is called the <code>soname</code>.
What's different on Darwin is that you can (and should) specify a full
path along with the file name.
This eliminates the need for "rpath" options and the
ldconfig/ld.so.cache system.
To use a library that is not yet installed, you can set the
DYLD_LIBRARY_PATH environment variable; see the dyld man page for
details.
</p>
<p>
The Mach-O format also offers real minor version checking, unknown on
ELF systems.
Every Mach-O library carries two version numbers: a "current" version
and a "compatibility" version.
Both version numbers are written as three numbers separated by dots,
e.g. 1.4.2.
The first number must be non-zero.
The second and third number can be omitted and default to zero.
When no version is specified, it will default to 0.0.0, which is some
kind of wildcard value.
</p>
<p>
The "current" version is for informational purposes only.
The "compatibility" version is used for checking as follows.
When an executable is linked, the version information from the library
is copied into the executable.
When the executable is run, that version information is checked
against the used library.
dyld generates a run time error and terminates the program unless the
used library version is equal to or newer than the one used during
linking.
</p>
</section>


<section name="cflags"><title>Compiler Flags</title>
<p>
The generation of position-independent code (PIC) is the default is
the default on Darwin.
Actually, PowerPC code is position-independent by design, so there is
no performance or space penalty involved.
So, you don't need to specify a PIC option when compiling code for a
shared library or module.
However, the linker doesn't allow "common" symbols in shared
libraries, so you must use the <code>-fno-common</code> compiler
option.
</p>
</section>


<section name="build-lib"><title>Building a Shared Library</title>
<p>
To build a shared library, you invoke the compiler driver with the
<code>-dynamiclib</code> option.
This is best demonstrated by a comprehensive example.
We'll build a library called libfoo, composed of the source files
source.c and code.c.
The version number is 2.4.5, where 2 is the major revision
(incompatible API change), 4 is the minor revision
(backwards-compatible API change) and 5 is the bugfix revision count
(some people call this the "teeny" revision, it denotes fully
compatible changes).
The library depends on no other shared libraries and will be installed
in /usr/local/lib.
</p>
<codeblock>cc -fno-common -c source.c
cc -fno-common -c code.c
cc -dynamiclib -install_name /usr/local/lib/libfoo.2.dylib \
 -compatibility_version 2.4 -current_version 2.4.5 \
 -o libfoo.2.4.5.dylib source.o code.o
rm -f libfoo.2.dylib libfoo.dylib
ln -s libfoo.2.4.5.dylib libfoo.2.dylib
ln -s libfoo.2.4.5.dylib libfoo.dylib</codeblock>
<p>
Note which parts of the version are used where.
Also note that the static linker will use the libfoo.dylib symlink,
while the dynamic linker will use the libfoo.2.dylib symlink.
It is possible to point these symlinks at different minor revisions of
the library.
</p>
</section>


<section name="build-mod"><title>Building a Module</title>
<p>
To build a loadable module, you invoke the compiler driver with the
<code>-bundle</code> option.
If the module uses symbols from the host program, you'll have to
specify <code>-undefined suppress</code> to allow undefined symbols,
and <code>-flat_namespace</code> along with it to make the new linker
in Mac OS X 10.1 happy.
A comprehensive example:
</p>
<codeblock>cc -fno-common -c source.c
cc -fno-common -c code.c
cc -bundle -flat_namespace -undefined suppress \
 -o mymodule.so source.o code.o</codeblock>
<p>
Note that no version numbering is used.
It is possible to use it in theory, but in practice it's pointless.
Also note that there are no naming restrictions for bundles.
Some packages prefer to prepend a "lib" anyway because some other
systems require it; this is harmless.
</p>
</section>


</chapter>


<chapter filename="libtool">
<title>GNU libtool</title>
<shorttitle>libtool</shorttitle>

<preface>
<p>
GNU packages that build libraries use GNU libtool to hide
platform-dependent procedures for library building and installation.
</p>
</preface>

<section name="situation"><title>The Situation</title>
<p>
In the wild, one can find four strands of libtool:
</p>
<ul>

<li><p>
<em>libtool 1.3</em>:
The most common strand.
The last release from this branch is 1.3.5.
It doesn't know about Darwin and only builds static libraries.
It can be recognized by the presence of the files
<filename>ltconfig</filename> and <filename>ltmain.sh</filename> in
the source tree.
</p></li>

<li><p>
<em>libtool 1.4</em>:
Long in the works and recently released as the new
stable version, this branch has better autoconf integration.
Unfortunately that makes migrating packages from 1.3 non-trivial.
It supports Darwin 1.3 / Mac OS X 10.0 out of the box and needs a
small patch to work on Mac OS X 10.1.
It can be recognized by the absence of <filename>ltconfig</filename>.
Versions that identify themselves as 1.3b or 1.3d are actually
development snapshots of 1.4 and must be treated with caution.
</p></li>

<li><p>
<em>The multi-language-branch</em>:
Also called MLB, this version of libtool was a parallel development
branch that added support for C++ and Java (via gcj).
It has now been merged back into the main development line.
Recent versions support Darwin 1.3 and Mac OS X 10.0 out of the box.
The MLB can be recognized by the files <filename>ltcf-c.sh</filename>,
<filename>ltcf-cxx.sh</filename> and <filename>ltcf-gcj.sh</filename>.
</p></li>

<li><p>
<em>The current development branch</em>:
This is the development version that will some day be released as
libtool 1.5.
It has resulted from the merge of 1.4 and the MLB.
It supports C, C++ and Java (via gcj).
Unfortunately, it can't be easily told apart from 1.4, you'll have to
check the version number inside <filename>ltmain.sh</filename>.
</p></li>

</ul>
<p>
In conclusion, libtool 1.3.x and packages that use it (which
happens to be the majority of libtool-using packages out there) need a
patch to build shared libraries on Darwin.
Apple includes a patched version of libtool 1.3.5 in Mac OS X, but it
will not work correctly in most cases.
I have improved that patch to hardcode the correct path and to do full
versioning.
The changes have been incorporated into upstream libtool releases and
development versions starting with 1.4.
I continue to make improvements and forward them to the libtool
maintainers.
The versioning scheme is compatible across all libtool versions.
</p>
<p>
Side note:
The libltdl library included with all libtool versions will only work
on Darwin when dlcompat is installed.
</p>
</section>


<section name="patch-135"><title>The 1.3.5 Patch</title>
<p>
After applying <link
url="http://fink.sourceforge.net/files/libtool-1.3.5-darwin.patch">this
patch</link> <em>[updated 2001-08-30]</em> to the libtool 1.3.5 source, you
must delete the files ltconfig and ltmain.sh.
They will be recreated from the appropriate .in files when you run
configure and make.
But that's only half the work - every package using libtool comes with
its own copies of ltconfig and ltmain.sh.
So you must replace these in every package that you want to build as a
shared library.
Note that you must do this before running the configure script.
For your convenience, you can get the two files right here:
<link url="http://fink.sourceforge.net/files/ltconfig">ltconfig</link> (98K) and
<link url="http://fink.sourceforge.net/files/ltmain.sh">ltmain.sh</link> (110K)
<em>[both updated 2001-08-30]</em>.</p>
</section>

<section name="fixing-14x"><title>Fixing 1.4.x</title>
<p>
There are at least three different versions of libtool 1.4.x now in wide use
(1.4.1, 1.4.2, and later development snapshots). They all have some issues on
Darwin, though the exact changes required to fix them differ. The libtool14
package shipped via Fink has all required patches already applied to it.
However, you still have to manually fix the ltmain.hs/configure files of
affected packages in order to get them working.
</p>

<ol>
<li>
<em>The flat_namespace bug</em>:
This problem only occurs if you use libtool on Mac OS X10.1 and later. What happens
is that libtool tries to use the <code>-undefined suppress</code> to allow undefined
symbols, but doesn't specify along with it the <code>-flat_namespace</code> option.
Starting with 10.1 this won't work anymore. A typical patch looks like this:
<codeblock>
diff -Naur gdk-pixbuf-0.16.0.old/configure gdk-pixbuf-0.16.0.new/configure
--- gdk-pixbuf-0.16.0.old/configure	Wed Jan 23 10:11:48 2002
+++ gdk-pixbuf-0.16.0.new/configure	Thu Jan 31 03:19:54 2002
@@ -3334,7 +3334,7 @@
     ;;
 
   darwin* | rhapsody*)
-    allow_undefined_flag='-undefined suppress'
+    allow_undefined_flag='-flat_namespace -undefined suppress'
     # FIXME: Relying on posixy $() will cause problems for
     #        cross-compilation, but unfortunately the echo tests do not
     #        yet detect zsh echo's removal of \ escapes.
</codeblock>
</li>
<li>
<em>The loadable module bug</em>:
This bug is caused by the non-standard behaviour of zsh (which is the default
shell in 10.0 and 10.1; in 10.2 it is supposed to be replaced by bash).
Zsh's non-standard quoting behaviours prevents loadable module from being built
correctly, they end up as shared libraries instead (unlike Linux, these are
reall different things on Darwin). A typical fix for this (cut off, so you can't
use it unmodified):
<codeblock>
diff -Naur gnome-core-1.4.0.6.old/configure gnome-core-1.4.0.6.new/configure
--- gnome-core-1.4.0.6.old/configure	Sun Jan 27 08:19:48 2002
+++ gnome-core-1.4.0.6.new/configure	Fri Feb  8 01:10:21 2002
@@ -4020,7 +4020,7 @@
     # FIXME: Relying on posixy $() will cause problems for
     #        cross-compilation, but unfortunately the echo tests do not
     #        yet detect zsh echo's removal of \ escapes.
-    archive_cmds='$nonopt $(test "x$module" = xyes &amp;&amp; echo -bundle || echo -dynamiclib) ...'
+    archive_cmds='$nonopt $(test x$module = xyes &amp;&amp; echo -bundle || echo -dynamiclib) ...'
     # We need to add '_' to the symbols in $export_symbols first
     #archive_expsym_cmds="$archive_cmds"' &amp;&amp; strip -s $export_symbols'
     hardcode_direct=yes
</codeblock>
<p>
This problem is fixed in some post-1.4.2 versions of libtool.
</p>
</li>
<li>
<em>The convenience library bug</em>:
Under some conditions, libtool will fail to link convenience libraries, 
giving "multiple definitions" errors.
This is caused by a more fundamental problem in libtool it seems. For now 
as a workaround (curing the symptoms
not the actual problem, but with great success anyway), you can use this fix
(thanks to Dave Vasilevsky):
<codeblock>
--- ltmain.sh.old       2002-04-27 00:01:23.000000000 -0400
+++ ltmain.sh   2002-04-27 00:01:45.000000000 -0400
@@ -2894,7 +2894,18 @@
        if test -n "$export_symbols" &amp;&amp; test -n "$archive_expsym_cmds"; then
          eval cmds=\"$archive_expsym_cmds\"
        else
+         save_deplibs="$deplibs"
+         for conv in $convenience; do
+       tmp_deplibs=
+       for test_deplib in $deplibs; do
+         if test "$test_deplib" != "$conv"; then
+           tmp_deplibs="$tmp_deplibs $test_deplib"
+         fi
+       done
+       deplibs="$tmp_deplibs"
+         done
          eval cmds=\"$archive_cmds\"
+         deplibs="$save_deplibs"
        fi
        save_ifs="$IFS"; IFS='~'
        for cmd in $cmds; do
</codeblock>
</li>
<li>
<em>The DESTDIR bug</em>:
Certain packages which set DESTDIR and use libtool 1.4.2 have problems
with relinking.
The problems are discussed in these email messages: </li><li>
<link
url="http://mail.gnu.org/pipermail/bug-libtool/2002-February/003018.html">http://mail.gnu.org/pipermail/bug-libtool/2002-February/003018.html</link> </li><li>
<link
url="http://mail.gnu.org/pipermail/libtool/2002-April/006244.html">http://mail.gnu.org/pipermail/libtool/2002-April/006244.html</link> </li><li>
<link
url="http://mail.gnu.org/pipermail/libtool/2002-April/006250.html">http://mail.gnu.org/pipermail/libtool/2002-April/006250.html</link>,
</li><li>and a patch for the problem is discussed in these messages:</li><li>
<link
url="http://mail.gnu.org/pipermail/libtool/2002-April/006268.html">http://mail.gnu.org/pipermail/libtool/2002-April/006268.html</link> </li><li>
<link url="http://mail.gnu.org/pipermail/bug-libtool/2002-February/003019.html">http://mail.gnu.org/pipermail/bug-libtool/2002-February/003019.html</link>
</li>
</ol>
</section>

<section name="notes"><title>Further Notes</title>
<p>
For more information on libtool itself and what it does, see the <link
url="http://www.gnu.org/software/libtool/libtool.html">libtool
homepage</link>.
</p>

<p>
Side note:
Apple's Developer Tools contain a program also called libtool, which
is used by the compiler driver to build shared libraries.
However, this is completely unrelated with GNU libtool.
The GNU libtool that Apple ships is installed as <code>glibtool</code>
instead.
This can be achieved by configuring GNU libtool with
<code>--program-transform-name=s/libtool/glibtool/</code>.
</p>
</section>

</chapter>

<chapter filename="preparing">
<title>Preparing for 10.2</title>
<shorttitle>Preparing for 10.2</shorttitle>


<section name="bash"><title>The bash shell</title>
<p>
Fink made the transition from OS X 10.0 to OS X 10.1 fairly easily, thanks
in part to planning ahead for the changes that were coming.  We will try
to do the same for the next transition, but not many details are known
yet. </p>
<p> We understand that OS X 10.2 will use bash rather than zsh to provide
<code>/bin/sh</code> functionality.  This has at least three implications
for fink. 
</p>
<ul><li>
In the past, some fink packages created a CompileScript (or PatchScript or
InstallScript) which does nothing
by simply putting a semicolon in the script.  This does not work
under bash, and must be replaced by something like
<codeblock>
  CompileScript: echo "nothing to do"
</codeblock>
</li>
<li>
In the past, some fink packages used a the <code>lib(foo|bar).dylib</code>
construction to refer to two libraries at once; this doesn't work under
bash (and the bash alternative <code>lib{foo,bar}.dylib</code> doesn't work
under zsh).  Solution: write out the names in full.
</li>
<li>
A libtool patch is needed in many cases, to prevent libraries from being
build unversioned under bash.  
<em> Note: you do not need this patch with
 libtool-1.3.5, for example, if you are using UpdateLibtool:
 True. </em>
The symptom: when building under bash,
you see
<codeblock>
../libtool: test: too many arguments
</codeblock>
When this happens, <code>configure</code> contains the following:
<codeblock>
archive_cmds='$CC $(test .$module = .yes &amp;&amp; echo -bundle || echo 
-dynamiclib) $allow_undefined_flag -o $lib $libobjs $deplibs$linkopts 
-install_name $rpath/$soname $(test -n "$verstring" -a x$verstring != 
x0.0 &amp;&amp; echo $verstring)'
</codeblock>
Here is a patch (but it must be used with care, because sometimes there are
other libtool problems as well so this patch must be applied by hand):
<codeblock>
diff -Naur gdk-pixbuf-0.16.0/configure gp-new/configure
--- gdk-pixbuf-0.16.0/configure 2002-01-22 20:11:48.000000000 -0500
+++ gp-new/configure    2002-05-10 03:02:44.000000000 -0400
@@ -3338,7 +3338,7 @@
      # FIXME: Relying on posixy $() will cause problems for
      #        cross-compilation, but unfortunately the echo tests do not
      #        yet detect zsh echo's removal of \ escapes.
-    archive_cmds='$CC $(test .$module = .yes &amp;&amp; echo -bundle || echo 
-dynamiclib) $allow_undefined_flag -o $lib $libobjs $deplibs$linkopts 
-install_name $rpath/$soname $(test -n "$verstring" -a x$verstring != 
x0.0 &amp;&amp; echo $verstring)'
+    archive_cmds='$CC $(test .$module = .yes &amp;&amp; echo -bundle || echo 
-dynamiclib) $allow_undefined_flag -o $lib $libobjs $deplibs$linkopts 
-install_name $rpath/$soname $tmp_verstring'
      # We need to add '_' to the symbols in $export_symbols first
      #archive_expsym_cmds="$archive_cmds"' &amp;&amp; strip -s $export_symbols'
      hardcode_direct=yes
diff -Naur gdk-pixbuf-0.16.0/ltmain.sh gp-new/ltmain.sh
--- gdk-pixbuf-0.16.0/ltmain.sh 2002-01-22 20:11:43.000000000 -0500
+++ gp-new/ltmain.sh    2002-05-10 03:04:49.000000000 -0400
@@ -2862,6 +2862,11 @@
        if test -n "$export_symbols" &amp;&amp; test -n "$archive_expsym_cmds";
	then
          eval cmds=\"$archive_expsym_cmds\"
        else
+         if test "x$verstring" = "x0.0"; then
+           tmp_verstring=
+         else
+           tmp_verstring="$verstring"
+         fi
          eval cmds=\"$archive_cmds\"
        fi
        IFS="${IFS=     }"; save_ifs="$IFS"; IFS='~'
</codeblock>
</li>
</ul>
</section>
<section name="gcc3"><title>The gcc3 compiler</title>
<p>Mac OS X 10.2 will use the gcc3 compiler, and at the moment, the Fink team
is experimenting with this on Fink packages, using the version of gcc3
which Apple provided with the April 2002 Developer Tools.  
</p><p>In general, many packages which have loadable modules and use
libtool are 
failing with an install_name error at the moment, because libtool passes
the -install_name flag even along with the -bundle flag (when it is not
strictly needed).  This behavior was accepted by the gcc2 compiler but is
not being accepted by the gcc3 compiler.  A fix has been found by Ben
Hines; please <link
url="http://www.mail-archive.com/fink-devel@lists.sourceforge.net/msg02025.html">help
him test it.</link>
Note that you do not need Ben's patch if your package uses libtool-1.3.5
(for example, if you are using <code>UpdateLibtool: True</code>)
since it has already been incorporated into a revised version of fink's
ltconfig file (available in pre-release versions of fink).
</p>
<p>JF Mertens has provided an 
<link url="http://fink.sourceforge.net/doc/porting/gcc3_errs.php">extensive 
list of packages which fail to compile under gcc3,</link> updated
on 22 June 2002. </p>
<p>
Earlier reports, originally compiled on  May 22 and updated several times,
were provided by Jeff
Hester, Jan de Leeuw, J-F Mertens, Mathias Meyer, Alexander Strange,
and Chris Zubrzycki.  Those lists, now somewhat out of date, follow:
</p><p><em> Unsuccessful packages:</em></p>
<ol><li> apt-0.5.4-3 (breaks with undefined symbols such as 
__ZTI9pkgSystem) </li>
<li>bonobo-1.0.20-1(breaks with install_name error) <em>fixed June 12</em></li>
<li><link url="http://www.mail-archive.com/fink-devel@lists.sourceforge.net/msg02051.html">emacs21</link></li>
<li>gaim-0.57-1 (breaks with install_name error) <em>fixed June 13</em></li>
<li>galeon-1.2.1-1</li>
<li>gconf-1.0.9-1(breaks with install_name error) <em>fixed June 12</em></li>
<li>gnome-core-1.4.0.8-1 (breaks with install_name error) <em>fixed June 12</em></li>
<li>gnome-vfs-1.0.5-4 (breaks with install_name error) <em>fixed June 12</em></li>
<li>gv-3.5.8-4</li>
<li>
<codeblock>
lftp-ssl_2.5.2-2 failed with :
g++ -DHAVE_CONFIG_H -I. -I. -I../include -I../include   -no-cpp-precomp 
-I/sw/include  -O2 -Wall -Wwrite-strings -Woverloaded-virtual 
-fno-exceptions -fno-rtti -fno-implement-inlines -Winline -c -o 
FileCopyFtp.o `test -f FileCopyFtp.cc || echo './'`FileCopyFtp.cc
In file included from FileAccess.h:27,
                 from FileCopy.h:38,
                 from FileCopyFtp.h:26,
                 from FileCopyFtp.cc:27:
../include/trio.h:172:1: warning: "vfscanf" redefined
In file included from ../include/trio.h:25,
                 from FileAccess.h:27,
                 from FileCopy.h:38,
                 from FileCopyFtp.h:26,
                 from FileCopyFtp.cc:27:
/usr/include/stdio.h:330:1: warning: this is the location of the 
previous definition
In file included from log.h:26,
                 from FileCopyFtp.cc:28:
/usr/include/unistd.h:135: declaration of C function `int getopt(int, 
char*
   const*, const char*)' conflicts with
../include/getopt.h:104: previous declaration `int getopt()' here
make[1]: *** [FileCopyFtp.o] Error 1
</codeblock></li>
<li>libghttp-1.0.9-3 (internal link edit command failed)</li>
<li>librep-0.14-6 (breaks with install_name error) <em>install_name error
was fixed but there are other problems now</em></li>
<li>libxml2-2.4.22-1 (breaks with install_name error) <em>fixed June 11</em></li>
<li>libxslt-1.0.18-1 failed with install_name error <em>seems OK as of June 13</em></li>
<li>mc-4.5.55-1 (see log)</li>
<li>mozilla-1.0rc3-1 (iid_NS_ISUPPORTS_IID causes a section type conflict, 
see log)</li>
<li>nautilus-1.0.6-2 (breaks with install_name error)</li>
<li>qt3-3.0.4-5</li>
<li>
readline-4.2a-5 has undefined symbol errors and others.
</li>
<li>
stlport-4.5-1 fails since the start...</li>
<li>tads-2.5.5-3 breaks because of weird va_args() calling</li>
<li>
ddd-3.3.1-3:
<codeblock>
c++ -DHAVE_CONFIG_H -I. -I. -I. -I./.. -isystem /usr/X11R6/include  
-no-cpp-precomp -I/sw/include  -DNDEBUG -O2 -g -W -Wall -mminimal-toc  
-trigraphs  -c logplayer.C
In file included from 
/usr/include/gcc/darwin/3.1/g++-v3/backward/iostream.h:31,
                  from strclass.h:412,
                  from logplayer.h:36,
                  from logplayer.C:36:
/usr/include/gcc/darwin/3.1/g++-v3/backward/backward_warning.h:32:2: 
warning: #warning This file includes at least one deprecated or 
antiquated header. Please consider using one of the 32 headers found in 
section 17.4.1.2 of the C++ standard. Examples include substituting the 
&lt;X&gt; header for the &lt;X.h&gt; header for C++ includes, or &lt;sstream%gt; instead 
of the deprecated header &lt;strstream.h&gt;. To disable this warning use 
-Wno-deprecated.
In file included from logplayer.h:36,
                  from logplayer.C:36:
strclass.h: In member function `string&amp; 
string::operator=(std::ostrstream&amp;)':
strclass.h:1059: warning: unused variable `const int frozen'
In file included from logplayer.C:46:
/usr/include/gcc/darwin/3.1/g++-v3/backward/fstream.h: At global scope:
/usr/include/gcc/darwin/3.1/g++-v3/backward/fstream.h:38: using 
declaration `
    streampos' introduced ambiguous type `streampos'
make[1]: *** [logplayer.o] Error 1
</codeblock></li>
<li>
qt3-3.0.4-7:
<codeblock>
ld: .obj/release-mt/qimage.o has external relocation entries in 
non-writable section (__TEXT,__text) for symbols:
__Z4endlR11QTextStream
/usr/bin/libtool: internal link edit command failed
</codeblock></li>
<li>smpeg-0.4.4-4 (undefined symbols)</li>
<li>sdl-mixer-1.2.4-1 (Normal, since it depends on the c++ package smpeg 
which didn't build)</li>
<li>sdl-ttf-2.0.5-1</li>
<li>dejagnu-1.4.1-1 (Breaks since the start, possibly too old c++ code, and 
not worth fixing
before going to version 1.4.2)</li>
<li>pango1-1.0.2-1, gtk+2-2.0.3-1, gdk-pixbuf-0.16.0-6: install_name error</li>
<li>fftw with "-enable fortran" (ie, the one I have in 'local') ("fortran 
compiler cannot create executables")</li>
<li>fort77-1.18-3 (fails in the tests, I guess because the interface to the
(c++) f2c libraries to which it links has changed)</li>
<li>netcdf-3.5.0-5</li>
<li>Failures, from J-F Mertens on June 12:
orbit2-2.3.108-2 ( install_name error) prcs-1.3.1-1 aspell-.33.7.1-2 
plotutils-2.4.1-2 cyrus-sasl-1.5.27-2 a2ps-4.12-4 libghttp-1.0.9-3 
librep-0.14-6 (install_name error) libsigc++-1.0.4-2 (undefined symbols)
sendfile: autoconf error... (autoconf25 is installed, I'll retry once 
without, or with autoconf)
</li>
<li>Failures, from J-F Mertens on June 13:
libxml++-0.13-1: configure produces no makefile. There are 'ld: 
Undefined symbols' errors in the config.log _ but I'm not sure at all 
this is the problem.
NOTE: Maintainer = None
smlnj-runtime-110.39-2
postgresql-7.1.3-4 (the first compilation, 'gcc -traditional-cpp 
-g ....', fails _ flags are still adequate ?)
g-wrap-1.1.11-4 (install_name error)
neon-ssl-0.18.5-3, neon19-ssl-0.19.4-1 (internal link edit command 
failed _ seems same problem in both)
macaulay2-0.9.2-4, cccc-3.pre54-1, cyclo-2.0-2 : again this 
backward_warning.h leading to error.
intercal-threaded-0.7-2 vtun-2.5b1-1 (parse errors)
fhist-1.8-2 nickle-1.99.2-1 teknap-1.3g-2 pwlib-1.2.10-3 
openh323-1.7.9-2 (the last one conceivably because of failure of pwlib, 
which uses c++ _ so it was build with a gcc2 pwlib installed)
And of course algae fails since no g77 compiler _ this is really urgent, 
even just a beta...
</li>
</ol>
<p><em> Successful packages:</em></p>
<ol>
<li>gnome-libs-1.4.1.6-1</li>
<li>sdl-1.2.4-2</li>
<li>mplayer-0.90pre4-1</li>
<li>windowmaker-0.80.0-7</li>
<li>pkgconfig-0.12.0-1</li>
<li>oaf-0.6.8-2</li>
<li>guile-1.4-4</li>
<li>openssl_0.9.6c-3</li>
<li>control-center_1.4.0.5-1</li>
<li>gal19_0.19.1-3</li>
<li>gtkhtml_1.0.1-3</li>
<li>galeon-1.2.1-1</li>
<li>aalib-1.4rc5-1</li>
<li>libglade-0.17-3</li>
<li>db3-3.3.11-7</li>
<li>python-2.2.1-5</li>
<li>glib2-2.0.1-3</li>
<li>pcre-3.9-2</li>
<li>libxslt-1.0.17-2</li>
<li>automake-1.6.1-1</li>
<li>lesstif-0.93.18-4</li>
<li><link
url="http://www.mail-archive.com/fink-devel@lists.sourceforge.net/msg02087.html">long
list from Chris Zubrzycki on May 29</link></li>
<li>From J-F Mertens on June 7: 
debianutils libiconv gettext ncurses bzip2 gzip tar dpkg
zlib dlcompat readline m4 autoconf25 automake15
make texinfo libtool libtool14 bison flex ssed gawk
and gengetopt (latest versions) build correctly with gcc3.
Also abiword-1.0.2-1, oaf-0.6.10-1 and netpbm-9.25-1
build correctly with gcc3.
 Compiled succesfully with gcc3:
 atlas-3.3.15-1 rrdtool-1.0.37-3 wget-ssl-1.8.2-1
</li>
<li>From Mathias Meyer on June 9:
libxslt-1.0.18-1
slang-1.4.5-3
librsvg-1.0.3-2
eel-1.0.2-3
libxpg4-20010605-17
fink-0.9.12-1
base-files-1.5-1
gzip-1.2.4a-6
</li>
<li>Additional successes, from J-F Mertens on June 8:
texi2html       1.64-1
findutils       4.1-4
man             1.5j-3
groff           1.17.2-1
grep            2.4.2-3
diffutils       2.8.1-1
patch           2.5.4-2
textutils       2.0-4
curl-ssl        7.9.7-1
cvs             1.11.2-1
nano            1.0.9-1
bash            2.05a-4
zsh             4.0.4-1
tcsh            6.11-1
fileutils       4.1-3
gdbm            1.8.0-6
gmp             4.0.1-2
expat           1.95.1-3
nano            1.0.9-1
bash            2.05a-4
zsh             4.0.4-1
tcsh            6.11-1
fileutils       4.1-3
gdbm            1.8.0-6
gmp             4.0.1-2
expat           1.95.1-3
tcltk           8.3.3-7
python          2.2.1-6
</li>
<li>Packages which work, from J-F Mertens on June 11:
Works: sgml-entities-iso8879-1986-3 docbook-dsssl-nwalsh-1.76-1 
docbook-dtd-4.1.2-2 gtk-doc-0.9-1 sdl-1.2.4-2 sdl-image-1.2.2-1 
sdl-net-1.2.4-1 xfree86-base-4.2.0-6 xfree86-rootless-4.2.0-2 
glib-1.2.10-6 libxpm-4.7-2 xforms-0.9999-3 gdbm-1.8.0-6 f2c-20020123-2 
geomview-1.8.1-3 worker-2.5.0-1 glib2-2.0.3-1 db3-3.3.11-7 
libtool-1.3.5-11 daemonic-20010902-1 passwd-20020329-1 anacron-2.3-3 
pcre-3.9-2 deborphan-1.0-1 audiofile-0.2.3-4 libjpeg-6b-5 gnupg-1.0.7-1 
gpgme-0.3.6-3 xfontpath-0.4-1 x-ghostscript-fonts-20020206-3 
freetype-hinting-1.3.1-6 freetype2-2.0.8-4 ttfmkfontdir-1.0-1 
xfonts-intl-1.2-1 ghostscript7.04-1 libtool14-1.4.2-6 epstool-2.1-1 
app-defaults-20010814-2 tcltk-8.3.3-7 expect-5.33.0-1 rrdtool-1.0.37-3 
ruby-1.6.6-2 tgif-4.1.41-1 xless-1.7-1 python-2.2.1-6 glib2-2.0.3-1 
atk1-1.0.2-1 esound-0.2.23-5 t1lib1-1.3.1-1 esound-0.2.27-1 
t1lib1-1.3.1-2 lesstif-0.93.18-6 xbae-4.9.1-6 xlt-9.2.9-2 
libpng-1.0.12-6 libjpeg-6b-5 libtiff-3.5.7-7 xmhtml-1.1.7-2 
gtk+-1.2.10-10 calcoo-1.3.8-1 giflib-4.1.0-5 netpbm-9.25-1 
imlib-1.9.10-9 orbit-0.5.15-2 gnome-libs-1.4.1.7-1 libxml-1.8.17-2 
libglade-0.17-3 libpoll-1.1-3 cups-1.1.14-1 xdelta-1.1.3-1 pdflib-4.0.2-1
</li>
<li>Build correctly (apparently..), from J-F Mertens on June 12:
openjade-1.3.1-1 libxml2-2.4.22-2 glib-1.2.10-7 guile-1.4-4 
scrollkeeper-0.2-7 gnome-print-0.36-1 gnome-games-1.4.0.4-2 
pdksh-5.2.14-2 scsh-0.5.3-1 db4-4.0.14-7 popt-1.6.2-2 gnet-1.1.2-1 
launch-1.0a9-2 pspell-.12.2-1 astyle-1.15.3-1 openldap-ssl-2.0.23-3 
cpio-2.4.2-3 dict-1.5.5-2 libwww-5.3.2-3 bc-1.06-1 hugs-1998.200102-3 
hx-0.1.39-5 hxd-0.1.39-2 indent-2.2.6-1 ispell-3.2.06-2 libogg-1.0rc3-3 
libpcap-0.6.2-5 libvorbis-1.0rc3-3 mutt-ssl-1.3.99i-1 ncftp-3.1.3-1 
netcat-1.10-4 pine-ssl-4.44-2 pth-1.4.0-6 recode-3.6-6 slang-1.4.5-3 
less-358-4 links-ssl-0.96-3 lynx-ssl-2.8.4-2 hfsutils-3.2.6-1 
python-fchksum-1.6.1-1 intltool-0.18-2 linc1-0.1.21-2 libidl2-0.7.4-3 
apache-1.3.23-1 (with the correction in the bug tracker) 
libproplist-0.10.1-4 rlpr-2.04-3 mysql-3.23.49-2 hermes-1.3.2-2 
libpng3-1.2.1-2 libmpeg-1.3.1-6 libmikmod-3.1.9-3 hexcurse-1.54-1 
metapixel-0.7-2 libfame-0.8.10-1 gnuplot-3.8h.0-7 compress-zlib-
pm-1.16-1 date-manip-pm-5.40-2 data-showtable-pm-3.3-1 cvs2cl-2.38-1 
lrzsz-0.12.20-1 zssh-1.4-2 yap-4.3.19-1 yafc-0.7.9-1 xml-writer-pm-0.4-2 
xml-parser-pm-2.30-2 xml-simple-pm-1.05-2 xml-regexp-pm-0.03-2 
xdelta-1.1.3-1 openurl-20010728-1 gc-6.0-4 w3m-ssl-0.2.5.1-1 w3m-
el-1.2.4-1 mpack-1.5-2 base64-1.3-1 mime-base64-pm-2.12-2 memoize-
pm-0.66-2 lzo-1.07-3 logcheck-1.1.1-2 uri-pm-1.18-1 unrtf-0.18.1-1 
tree-1.3-2 tmake-1.7-2 tie-ixhash-pm-1.21-2 tftp-hpa-0.26-1 
term-readline-pm-0.9908-1 term-progressbar-pm-1.0-2 term-readkey-
pm-2.18-1 sha-pm-1.2-1 libole2-0.2.4-2 libnet-1.0.2a-2 libnet-pm-1.09-2 
libiodbc-2.50.3-6 tcptraceroute-1.2-2 tcpflow-0.20-1 smpeg-0.4.4-5 
sdl-mixer-1.2.4-2 dnstracer-1.5-1 calcoo-1.3.9-1
</li>
<li>More successes, from J-F Mertens on June 13 :
gtk-doc-0.9-2 lesstif-0.93.18-7 aquaterm-0.3.0a-4 t1utils-1.26-1 
surfraw-1.0.7-1 stunnel-3.22-1
storable-pm-1.0.14-1 slib-2d2-2 singular-factory-1.3b-3 
singular-libfac-0.3.2-2 samba-ssl-2.2.4-1
rsync-2.5.5-1 rpl-1.3.0b3-1 rec-descent-pm-1.80-1 pure-ftpd-1.0.2-1 
psutils-a4-1.17-1 psgml-1.2.4-1
pinepgp-0.17.2-1 filter-util-pm-1.26-1 filter-simple-pm-0.77-1 gsl-1.1-1 
ee-1.4.2-3 dosunix-1.0.13-1
digest-md5-pm-2.16-5 dbi-pm-1.230-1 dbd-pg-pm-1.01-1 io-stringy- 
pm-2.108-1 mailtools-pm-1.44-1
mime-tools-pm-5.411a-1 convert-tnef-pm-0.17-1 mp3-info-pm-1.01-1 
inline-pm-0.43-2 ntop-1.1-1
libxpm-4.7-2 net-snmp-ssl-5.0-3 html-tagset-pm-3.03-2 html-fromtext-
pm-1.005-2 html-parser-pm-3.25-2
log-tracemsgs-pm-1.0-2 lingua-preferred-pm-0.1-2 
lingua-en-numbers-ordinate-pm-0.01-2
libxml-pm-0.07-2 libwww-pm-5.64-2 xml-dom-pm-1.39-1 libunicode-
gnome-0.4-2 keychain-1.7-1
joe-2.9.8-pre1-1 jless-358-iso254-1 ant-1.4.1-2 html-tableextract-
pm-1.07-2 hdf-4.1r4-2 hdf5-1.4.2-4
gpgme-0.3.6-3 gnut-0.4.28-2 finance-quote-pm-1.06-2 
finance-quotehist-pm-0.25-1 ettercap-ssl-0.6.5-1
dbd-mysql-pm-2.1017-1 jikes-1.15-1 xerces-j-2.0.1-1 xerces-j-
javadocs-2.0.1-1 xalan-j-2.2.D14-2
xalan-j-javadocs-2.2.D14-2 jdom-b7-2 compface-1.4-2 class-dump-2.1.5-1 
bsdmktemp-1.4-1 axel-1.0-1
appconfig-pm-1.52-1 anubis-3.0.0-1 align-1.0.0-1 afio-2.4.6-2 hc-1.1-1 
pccts-1.33.mr33-1
unicode-string-pm-2.06-2 lv-4.49.4-2 mhonarc-2.5.5-1 mad-0.14.2b-1 
gnujaxp-1.0beta1-1 junit-3.7-1
sitecopy-ssl-0.11.4-5 cadaver-ssl-0.19.1-1 lout-3.25-1 cook-2.19-1 
gsm-1.0.10-1 io-string-pm-1.01-1
babelfish-pm-0.10-1 gnome-user-docs-1.4.1.1-2 eperl-2.2.14-2 eperl-
pm-2.2.14-2 log4j-1.1.3-1
lclint-2.5r-1 macosx-file-pm-0.64-1 makepatch-2.00.08-1 mldbm-pm-2.00-1 
mldbm-sync-pm-0.25-1
xtail-2.1-1 smalleiffel-20010719-1 exuberant-ctags-5.2.3-1 
bow-20010926-1 calc-2.11.5t4.5-1
docbook-dsssl-ldp-3.8-2 bind9-ssl-9.2.1-1 gforth-0.5.0-1 moscow-ml-2.00-4
swi-prolog-lite-5.0.6-1 splint-3.0.1.6-1 metrics-1.0-2 mpg123-pre0.59s-3 
libdvdcss-1.1.1-2
libdivxdecore-0.4.7-1 detex-2.7-2 yydecode-0.2.8-2 tidy-4aug00-1 
cscope-15.3-1 jed-0.99-1
portsentry-1.1-1 junkbuster-2.0.2-1 lua-4.0-2 tolua-4.0a-2 
drscheme-103p1-1 librep-0.14-7 esound-0.2.27
Also:
clisp-2.27-1 (but some conftest crashes during configuration _ this 
happened already under gcc2 if I
remember well)
dhcp-3.0-2 (but: source has moved to 
ftp://ftp.isc.org/isc/dhcp/dhcp-3.0-history/)
sniffit-0.3.5-5, but install fails because of typos in info file:
./install-sh sniffit.5 /sw/src/root-
sniffit-0.3.5-5//sw/src/root-sniffit-0.3.5-5/sw/share/man/man5/sniffit.5
./install-sh sniffit.8 /sw/src/root-
sniffit-0.3.5-5//sw/src/root-sniffit-0.3.5-5/sw/share/man/man8/sniffit.8
</li>
</ol>
<p>Another issue with the gcc3 compiler is an incompatibility for C++ ABIs
between gcc2 and gcc3.  In practice, this means that C++ programs compiled
with gcc3 cannot link to libraries compiled with gcc2.</p>
<p>From J-F Mertens:
 If I understand correctly, for packages that depend on c++ libs, 
 those libs
 have first to be rebuild. I have no idea how to get an exact list of 
 all packages
 providing such libs, but going to my /sw/var/logs dir, the command
<code> grep 'c++' * | cut -f 1 -d . | sort | uniq</code>
 gave me the following list, which could be at least a start :
 aplus-fsf apt aria arts aspell astyle cccc clanlib cups cyclo db3 db4
 ddd dejagnu dpkg drscheme dx f2c g77 gc gengetopt geomview glib2
 gnome-apt gnome-games gnome-pim graphviz gtkmm gtop hdf5 icemc
 intercal-threaded jags kdebase3-ssl kdelibs3-ssl launch lftp-ssl
 libdivxdecore libsigc++ libxml++ macaulay2 mad mjpegtools mozilla mysql
 nautilus ncurses netcdf octave-atlas oleo openh323 openjade pango1
 plotutils prcs pspell pwlib python qcad qt qt3 qtella sagasu sdl sdl-net
 singular-factory singular-libfac smpeg source-highlight sppc stlport
 swig tela tmake unixodbc unrar wxgtk wxmac xfree86-rootless zoinks
</p>
</section>


</chapter>


</document>
